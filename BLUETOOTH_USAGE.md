# ESP32-S3 蓝牙功能使用说明

## 功能概述

本项目现在支持蓝牙功能，可以通过蓝牙连接接收远程控制命令，并发送红外数据到连接的设备。

**注意：这是一个完整的BLE GATT服务器实现，基于esp-idf-svc的真实API，参考了官方example1.rs。**

## 蓝牙功能特性

1. **BLE GATT服务器支持**
   - 设备名称: "ESP32-IR-Recorder"
   - 支持BLE连接和GATT服务
   - 完整的GATT服务器实现

2. **数据接收功能**
   - 真实的BLE GATT数据接收
   - 支持LED控制命令
   - 数据缓冲和处理
   - 支持写入特征

3. **数据发送功能**
   - 真实的BLE GATT数据发送
   - 红外数据通过指示特征传输
   - 支持多客户端连接

## 支持的控制命令

通过蓝牙发送以下命令可以控制LED：

- `red` - 设置LED为红色
- `green` - 设置LED为绿色  
- `blue` - 设置LED为蓝色
- `off` - 关闭LED

## 使用方法

### 1. 编译和烧录

```bash
cargo build
cargo run
```

### 2. 蓝牙连接

1. 启动设备后，设备会自动开始蓝牙广播
2. 在手机或其他蓝牙设备上搜索 "ESP32-IR-Recorder"
3. 配对并连接设备

### 3. 发送控制命令

连接成功后，可以通过蓝牙发送文本命令：
- 发送 "red" 控制LED变红
- 发送 "green" 控制LED变绿
- 发送 "blue" 控制LED变蓝
- 发送 "off" 关闭LED

### 4. 接收红外数据

当设备接收到红外信号时，会自动通过蓝牙发送数据到连接的设备，格式为：
```
IR: [脉冲数量] pulses
```

## 技术实现

- 使用ESP-IDF的蓝牙BLE栈
- 完整的BLE GATT服务器实现
- 基于esp-idf-svc的官方API
- 支持GAP和GATTS事件处理
- 多客户端连接管理
- 实时数据缓冲和状态管理
- 参考官方example1.rs实现

## 注意事项

1. 确保ESP32-S3支持蓝牙功能
2. 蓝牙和WiFi可能共享天线，注意信号干扰
3. 连接断开后会自动重连
4. 数据接收有缓冲区限制，避免发送过大数据

## 故障排除

- 如果蓝牙初始化失败，检查sdkconfig.defaults配置
- 如果连接失败，尝试重启设备
- 查看串口日志获取详细错误信息
